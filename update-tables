#! /bin/bash
#
# update-tables
# Copyright (C) 2016 Adrian Perez <aperez@igalia.com>
#
# Distributed under terms of the MIT license.
#
set -e

[[ -r EastAsianWidth.txt ]] || wget -c http://www.unicode.org/Public/UNIDATA/EastAsianWidth.txt
[[ -r DerivedGeneralCategory.txt ]] || wget -c http://www.unicode.org/Public/UNIDATA/extracted/DerivedGeneralCategory.txt

zero_table () {
	echo '-- Autogenerated from DerivedGeneralCategory.txt'
	echo 'return {'
	while read -r line ; do
		if [[ -z ${line} || ${line} = \#* ]] ; then
			continue
		fi
		read -a items <<< "${line}"
		if [[ ${items[2]} == Mn || ${items[2]} == Me ]] ; then
			if [[ ${items[0]} = *..* ]] ; then
				range=${items[0]}
				echo "0x${items%..*}, 0x${items#*..},"
			else
				echo "0x${items[0]}, 0x${items[0]},"
			fi
		fi
	done < DerivedGeneralCategory.txt
	echo '}'
}

wide_table () {
	echo '-- Autogenerated from EastAsianWidth.txt'
	echo 'return {'
	while read -r item rest ; do
		if [[ -z ${item} || ${item} = \#* ]] ; then
			continue
		fi
		range=${item%;*}
		flags=${item#*;}
		if [[ ${flags} = W* || ${flags} = F* ]] ; then
			if [[ ${range} = *..* ]] ; then
				echo "0x${range%..*}, 0x${range#*..},"
			else
				echo "0x${range}, 0x${range},"
			fi
		fi
	done < EastAsianWidth.txt
	echo '}'
}

zero_table > wcwidth/zerotab.lua
wide_table > wcwidth/widetab.lua
